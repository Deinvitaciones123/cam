<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Invitación</title>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Hugs+and+Kisses&display=swap');

  /* ===== Estilos base ===== */
  body{
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 0;
    min-height: 100svh;   /* mejor que 100vh en móvil */
    height: auto;
    overflow: auto;       /* permite scroll si hace falta */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    gap: clamp(10px, 3vw, 20px);
    padding: clamp(10px, 3vw, 18px) clamp(10px, 3vw, 18px) calc(12px + env(safe-area-inset-bottom));
    background-size: cover;
  }

  h2{
    font-family: 'Aparajita', serif;
    color:#b29874;
    font-size: clamp(24px, 6.5vw, 48px);
    text-shadow: 0 0 5px #ffb3c1, 0 0 10px #978663, 0 0 20px #978663;
    margin: 6px 0 4px;
  }

  /* Marco 4:3 */
  .frame-43{
    position: relative;
    width: min(100%, 720px);
    aspect-ratio: 4 / 3;            /* 4:3 real */
    border-radius: clamp(16px, 4vw, 26px);
    border: 5px solid #b29874;      /* marco único */
    overflow: hidden;
    box-shadow: 0 8px 24px rgba(151,134,99,.35), 0 0 20px #978663, 0 0 40px #ffb3c1, 0 0 60px #978663;
  }

  @supports not (aspect-ratio: 4/3){
    .frame-43::before{ content:""; display:block; padding-top:75%; }
  }

  /* Dentro del marco: ocupar todo, SIN bordes propios */
  .frame-43 > video,
  .frame-43 > img{
    position: absolute; inset: 0;
    width: 100%; height: 100%;
    object-fit: cover;
    border: 0 !important; box-shadow: none !important;
  }
  .frame-43 > img{ object-fit: contain; background: transparent; }

  /* Botones base */
  #btnsContainer {
    display:flex;
    flex-direction: column;
    gap: clamp(8px, 2.5vw, 12px);
    width: min(100%, 720px);
    align-items:center;
    justify-content:center;
  }
  #btnsContainer button{
    width: 100%;
    min-width: 160px;
    background: linear-gradient(45deg, #978663 , #b29874, #978663 );
    background-size: 400% 400%;
    border: none;
    color: white;
    padding: clamp(10px, 3vw, 14px) clamp(14px, 4vw, 18px);
    font-size: clamp(14px, 20px, 20px);
    font-weight: bold;
    border-radius: clamp(10px, 3vw, 14px);
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 6px 20px rgba(0,0,0,0.25);
    animation: gradientBG 5s ease infinite;
    position: relative;
    overflow: hidden;
  }
  #btnsContainer button:hover{
    transform: scale(1.03);
    box-shadow: 0 10px 25px rgba(0,0,0,0.35);
  }
  /* menos animación si el usuario lo prefiere */
  @media (prefers-reduced-motion: reduce){
    *{ animation: none !important; }
  }
  @keyframes gradientBG { 0%{background-position:0 50%} 50%{background-position:100% 50%} 100%{background-position:0 50%} }

  /* Grilla de miniaturas (opcional, para confirmar múltiples) */
  #thumbs{
    width: min(100%, 720px);
    display: none;            /* visible solo cuando hay múltiples */
    grid-template-columns: repeat(auto-fill, minmax(96px, 1fr));
    gap: 8px;
    margin-top: 6px;
  }
  #thumbs img{
    width: 100%;
    aspect-ratio: 1/1;
    object-fit: cover;
    border-radius: 10px;
    border: 2px solid #b29874;
  }

  /* En pantallas grandes, botones en hilera */
  @media (min-width: 768px){
    #btnsContainer{ flex-direction: row; }
    #btnsContainer button{ width: auto; }
  }
</style>
</head>
<body>
  <h2>¡Gracias por acompañarnos!</h2>

  <!-- Marco 4:3 para video/preview -->
  <div id="previewBox" class="frame-43">
    <video id="video" autoplay playsinline></video>
    <img id="preview" />
  </div>

  <!-- Rejilla de miniaturas (se mostrará si se eligen varias imágenes) -->
  <div id="thumbs"></div>

  <div id="btnsContainer">
    <button id="fotoBtn">Tomar Foto</button>
    <button id="flipBtn">Voltear Cámara</button>
    <button id="galleryBtn">Subir desde galería</button>
  </div>

  <!-- Input oculto para abrir la galería (ahora permite múltiples imágenes) -->
  <input id="picker" type="file" accept="image/*, video/*" multiple style="display:none" />

  <canvas id="canvas" style="display:none;"></canvas>

<script>
  /* =========================
     Variables y estado
  ========================== */
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const context = canvas.getContext("2d");
  const preview = document.getElementById("preview");
  const thumbs = document.getElementById("thumbs");
  const btnsContainer = document.getElementById("btnsContainer");
  const picker = document.getElementById("picker");

  let stream;
  let useFront = true;

  // Cola de archivos a subir (solo imágenes aquí)
  // [{ filename, mime, data (base64), isVideo:false }, ...]
  let uploadQueue = [];

  // Tu endpoint de Apps Script (usa /exec)
  const ENDPOINT = "https://script.google.com/macros/s/AKfycbx-SsJMltuulN-Dy_-P3yO5YJLyVf0McXf37AUiSpYy_7YZjiVe4pC92dgZkmJMWjMKFw/exec";

  /* =========================
     Cámara
  ========================== */
  async function startCamera() {
    // Limpiar video si venía de galería
    if (video) {
      video.removeAttribute('src');
      if (typeof video.load === "function") video.load();
    }
    // Detener stream anterior
    if (stream) stream.getTracks().forEach(t => t.stop());

    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: useFront ? "user" : "environment" }
      });
    } catch (err) {
      console.error(err);
      alert("No se pudo acceder a la cámara.");
      return;
    }

    // Limpiar estado
    uploadQueue = [];
    thumbs.style.display = "none";
    thumbs.innerHTML = "";

    // Mostrar cámara
    video.srcObject = stream;
    video.style.display = "block";
    video.controls = false;
    preview.style.display = "none";

    renderInitialButtons();
  }

  function renderInitialButtons(){
    btnsContainer.innerHTML = `
      <button id="fotoBtn">Tomar Foto</button>
      <button id="flipBtn">Voltear Cámara</button>
      <button id="galleryBtn">Subir desde galería</button>
    `;
    document.getElementById("fotoBtn").onclick = takePhoto;
    document.getElementById("flipBtn").onclick = () => { useFront = !useFront; startCamera(); };
    document.getElementById("galleryBtn").onclick = () => picker.click();
  }

  async function takePhoto() {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0);
    const imgData = canvas.toDataURL("image/png");

    // Mostrar previsualización (la primera)
    preview.src = imgData;
    preview.style.display = "block";
    video.style.display = "none";

    // Guardar en cola (siempre imagen)
    uploadQueue = [{ filename: "foto.png", mime: "image/png", data: imgData, isVideo: false }];

    renderReviewButtons();
  }

  /* =========================
     Galería múltiple
  ========================== */
  // Helper: leer como DataURL (promesa)
  function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = () => reject(new Error("No se pudo leer el archivo"));
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(file);
    });
  }

  picker.addEventListener("change", async (e) => {
    const files = Array.from(e.target.files || []);
    if (!files.length) return;

    // Detener cámara si estaba activa
    if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }

    // Solo imágenes
    const imageFiles = files.filter(f => f.type.startsWith("image/"));
    if (!imageFiles.length) { alert("Selecciona imágenes, por favor."); e.target.value = ""; return; }

    try {
      const dataURLs = await Promise.all(imageFiles.map(readFileAsDataURL));
      uploadQueue = imageFiles.map((f, i) => ({
        filename: f.name || `imagen_${i + 1}.png`,
        mime: f.type || "image/png",
        data: dataURLs[i],
        isVideo: false
      }));

      // Mostrar preview principal (primera imagen)
      video.style.display = "none";
      if (video) {
        video.removeAttribute('src');
        if (typeof video.load === "function") video.load();
      }
      preview.src = uploadQueue[0].data;
      preview.style.display = "block";

      // Mostrar miniaturas si hay varias
      if (uploadQueue.length > 1) {
        thumbs.innerHTML = uploadQueue.map(item => `<img src="${item.data}" alt="thumb">`).join("");
        thumbs.style.display = "grid";
      } else {
        thumbs.style.display = "none";
        thumbs.innerHTML = "";
      }

      renderReviewButtons();
    } catch (err) {
      console.error(err);
      alert("Ocurrió un error al leer los archivos.");
    } finally {
      // permitir volver a elegir los mismos archivos
      e.target.value = "";
    }
  });

  function renderReviewButtons() {
    const count = uploadQueue.length;
    const label = count > 1 ? `Subir ${count} imágenes` : 'Subir';
    const retake = 'Cancelar / Volver a cámara';

    btnsContainer.innerHTML = `
      <button id="uploadBtn">${label}</button>  
      <button id="retakeBtn">${retake}</button>
    `;
    document.getElementById("uploadBtn").onclick = uploadSelected;
    document.getElementById("retakeBtn").onclick = () => startCamera();
  }

  /* =========================
     Subida (simultánea)
  ========================== */
  async function postOne(dataURL) {
    // Intento normal (sin headers para evitar preflight)
    try {
      const res = await fetch(ENDPOINT, {
        method: "POST",
        body: JSON.stringify({ image: dataURL }) // tu doPost usa "image"
      });
      // si CORS permite, lo contamos OK
      await res.text();
      return true;
    } catch (_) {
      // Fallback no-cors: no podremos leer la respuesta, pero sí se envía
      try {
        await fetch(ENDPOINT, {
          method: "POST",
          mode: "no-cors",
          body: JSON.stringify({ image: dataURL })
        });
        return true;
      } catch (e2) {
        console.error("Fallo al enviar una imagen:", e2);
        return false;
      }
    }
  }

  async function uploadSelected() {
    if (!uploadQueue.length) { alert("No hay imágenes para subir."); return; }

    // Deshabilitar botón para evitar dobles clics
    const uploadBtn = document.getElementById("uploadBtn");
    if (uploadBtn) { uploadBtn.disabled = true; uploadBtn.textContent = "Enviando..."; }

    // Subir en simultáneo
    const results = await Promise.all(uploadQueue.map(item => postOne(item.data)));
    const ok = results.filter(Boolean).length;
    const fail = results.length - ok;

    alert(`Listo: ${ok} enviada(s) correctamente${fail ? `, ${fail} falló/fallaron` : ""}.`);
    finishScreen();
  }

  function finishScreen() {
    if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; }
    document.body.innerHTML = `
      <h1 style="
        font-family: 'Aparajita', serif;
        color: #b29874; font-size: clamp(28px, 7vw, 50px); text-align: center; margin: 10% 16px 0;
        text-shadow: 0 0 5px #ffb3c1, 0 0 10px #978663 , 0 0 20px #978663;">
        ¡Gracias! Tus archivos fueron enviados.
      </h1>
    `;
    document.body.style.backgroundSize = "cover";
    document.body.style.display = "flex";
    document.body.style.justifyContent = "center";
    document.body.style.alignItems = "center";
    document.body.style.flexDirection = "column";
    document.body.style.minHeight = "100vh";
  }

  /* =========================
     Inicio
  ========================== */
  startCamera();
  // listeners por si el DOM tarda
  document.getElementById("fotoBtn")?.addEventListener("click", takePhoto);
  document.getElementById("galleryBtn")?.addEventListener("click", () => picker.click());
</script>
</body>
</html>
