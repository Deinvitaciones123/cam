<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Invitaci√≥n</title>

<!-- TIP: sustituye la fuente por una que s√≠ exista en Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">

<style>
  :root{
    --pink:#ff6ec7; --peach:#ff8c42; --white:#fff;
  }

  body {
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 0;
    min-height: 100vh;
    overflow: hidden;
    background: url('/assets/fondo.gif') no-repeat center center fixed; /* hospeda el gif t√∫ */
    background-size: cover;
    display: grid;
    place-items: center;
    padding: 24px;
    gap: 20px;
  }

  .wrap { display:flex; flex-direction:column; align-items:center; gap:18px; z-index:1; }

  h2 {
    font-family: "Great Vibes", cursive;
    color: var(--white);
    font-size: clamp(36px, 6vw, 64px);
    text-shadow: 0 0 5px #ffb3c1, 0 0 10px var(--pink), 0 0 20px var(--pink);
    margin: 0 0 6px;
  }

  .btn {
    background: linear-gradient(45deg, var(--pink), var(--peach), var(--pink));
    background-size: 400% 400%;
    border: none; color:#fff;
    padding: 14px 28px; font-size: 18px; font-weight: 700;
    border-radius: 14px; cursor: pointer;
    transition: transform .25s ease, box-shadow .25s ease;
    box-shadow: 0 6px 20px rgba(0,0,0,.25);
    animation: gradientBG 5s ease infinite;
  }
  .btn:hover { transform: scale(1.06); box-shadow: 0 10px 25px rgba(0,0,0,.35); }

  @keyframes gradientBG {
    0% {background-position: 0% 50%;}
    50% {background-position: 100% 50%;}
    100% {background-position: 0% 50%;}
  }

  #video, #preview {
    border-radius: 22px;
    border: 4px solid var(--peach);
    width: min(92vw, 520px);
    height: min(69vw, 390px);
    object-fit: cover;
    box-shadow: 0 0 20px var(--pink), 0 0 40px #ffb3c1, 0 0 60px var(--pink);
    background: rgba(0,0,0,.2);
  }

  /* espejo para selfie */
  #video { transform: scaleX(-1); animation: glow 2s ease-in-out infinite alternate; }
  @keyframes glow {
    0% { box-shadow: 0 0 20px var(--pink), 0 0 40px #ffb3c1, 0 0 60px var(--pink); }
    100%{ box-shadow: 0 0 40px var(--pink), 0 0 60px #ffb3c1, 0 0 80px var(--pink); }
  }

  .float { position: fixed; inset: 0; pointer-events:none; }
  .heart, .star {
    position: absolute; width: 18px; height: 18px;
    animation: floatUp linear infinite;
    will-change: transform, opacity;
  }
  .heart { background-color: rgba(255,108,199,.8);
    clip-path: polygon(50% 0%,61% 12%,75% 12%,87% 25%,87% 38%,75% 50%,50% 75%,25% 50%,13% 38%,13% 25%,25% 12%,39% 12%); }
  .star { background-color: rgba(255,255,255,.7);
    clip-path: polygon(50% 0%,61% 35%,98% 35%,68% 57%,79% 91%,50% 70%,21% 91%,32% 57%,2% 35%,39% 35%); }
  @keyframes floatUp {
    0% { transform: translateY(100vh) scale(1); opacity: 0; }
    10% { opacity: 1; }
    100% { transform: translateY(-100px) scale(.5); opacity: 0; }
  }

  .hidden { display:none !important; }

  /* estado final */
  body.done { display:grid; place-items:center; }
  body.done .wrap, body.done .float { display:none; }
  .thanks {
    font-family: "Great Vibes", cursive; color: #fff;
    font-size: clamp(32px, 5vw, 56px);
    text-align:center; padding: 16px;
    text-shadow: 0 0 5px #ffb3c1, 0 0 10px var(--pink), 0 0 20px var(--pink);
  }
</style>
</head>
<body>
  <div class="float" aria-hidden="true" id="floatLayer"></div>

  <div class="wrap" id="ui">
    <h2>¬°Gracias por acompa√±arnos!</h2>

    <video id="video" playsinline autoplay muted class="hidden" aria-label="Vista previa de la c√°mara"></video>
    <img id="preview" alt="Foto tomada" class="hidden"/>

    <div id="btns">
      <button class="btn" id="startBtn" aria-label="Activar c√°mara">Activar c√°mara</button>
      <button class="btn hidden" id="shotBtn" aria-label="Tomar foto">Tomar foto</button>
      <button class="btn hidden" id="retakeBtn" aria-label="Tomar otra foto">Tomar otra</button>
      <button class="btn hidden" id="uploadBtn" aria-label="Subir foto">Subir</button>
    </div>

    <canvas id="canvas" class="hidden"></canvas>
  </div>

  <!-- Botones extra para c√°mara -->
<div id="camControls" style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
  <button class="btn" id="startBtn" aria-label="Activar c√°mara">Activar c√°mara</button>
  <button class="btn" id="toggleFacingBtn" aria-label="Cambiar c√°mara" style="display:none;">Cambiar a trasera</button>
  <select id="cameraSelector" class="btn" style="display:none; padding:10px;"></select>
</div>

<script>
(() => {
  const video = document.getElementById('video');           // ya lo tienes en tu HTML
  const preview = document.getElementById('preview');       // idem
  const canvas = document.getElementById('canvas');         // idem
  const shotBtn = document.getElementById('fotoBtn') || document.getElementById('shotBtn'); // compat
  const btnsContainer = document.getElementById('btnsContainer') || document.getElementById('btns');
  const startBtn = document.getElementById('startBtn');
  const toggleFacingBtn = document.getElementById('toggleFacingBtn');
  const cameraSelector = document.getElementById('cameraSelector');

  let stream = null;
  let currentFacing = 'user';      // 'user' = frontal (selfie), 'environment' = trasera
  let currentDeviceId = null;      // cuando elijas expl√≠citamente una c√°mara

  // util
  const show = el => el && (el.style.display = '');
  const hide = el => el && (el.style.display = 'none');

  // Lista c√°maras tras tener permiso
  async function listCameras() {
    try {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videos = devices.filter(d => d.kind === 'videoinput');
      cameraSelector.innerHTML = '';
      videos.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.deviceId;
        opt.textContent = d.label || `C√°mara ${cameraSelector.length + 1}`;
        cameraSelector.appendChild(opt);
      });
      if (videos.length > 1) {
        show(cameraSelector);
      } else {
        hide(cameraSelector);
      }
    } catch (e) {
      // algunos navegadores no dan labels hasta que hay permiso
      hide(cameraSelector);
    }
  }

  // Inicia c√°mara con constraints (por facingMode o deviceId)
  async function startCamera({ facingMode = currentFacing, deviceId = currentDeviceId } = {}) {
    try {
      // detener stream previo
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }

      const constraints = { audio: false, video: {} };
      if (deviceId) {
        constraints.video.deviceId = { exact: deviceId };
      } else {
        constraints.video.facingMode = { ideal: facingMode }; // frontal o trasera
      }

      stream = await navigator.mediaDevices.getUserMedia(constraints);

      video.srcObject = stream;
      // iOS necesita playsinline para no full-screen
      video.setAttribute('playsinline', 'true');
      video.muted = true; // ayuda en iOS para autoplay
      await new Promise(res => (video.onloadedmetadata = res));
      await video.play();

      // UI
      show(video);
      hide(preview);
      show(toggleFacingBtn);
      toggleFacingBtn.textContent = (facingMode === 'user') ? 'Cambiar a trasera' : 'Cambiar a frontal';

      // ya tenemos permiso ‚Üí podemos listar c√°maras con nombres
      await listCameras();

      // si hay deviceId activo, selecci√≥nalo en el selector
      if (deviceId) {
        [...cameraSelector.options].forEach(o => (o.selected = (o.value === deviceId)));
      }
    } catch (err) {
      // Errores comunes y mensaje claro
      let msg = 'No se pudo abrir la c√°mara.';
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        msg += '\n‚Ä¢ Necesitas abrir la p√°gina con HTTPS (requisito del navegador).';
      }
      if (err && err.name === 'NotAllowedError') {
        msg += '\n‚Ä¢ Permiso denegado: revisa los permisos del navegador.';
      } else if (err && err.name === 'NotFoundError') {
        msg += '\n‚Ä¢ No se encontr√≥ c√°mara disponible.';
      } else if (err && err.name === 'OverconstrainedError') {
        msg += '\n‚Ä¢ La c√°mara solicitada no cumple los constraints (intenta la otra).';
      }
      alert(msg + (err?.message ? '\n\nDetalle: ' + err.message : ''));
      hide(toggleFacingBtn);
      hide(cameraSelector);
    }
  }

  // Tomar foto (respeta tu flujo existente)
  async function takePhoto() {
    const vw = video.videoWidth, vh = video.videoHeight;
    if (!vw || !vh) { alert('La c√°mara a√∫n no est√° lista. Intenta de nuevo.'); return; }
    canvas.width = vw; canvas.height = vh;
    const ctx = canvas.getContext('2d');

    // Si el video est√° espejeado (selfie), deshaz el espejo al dibujar al canvas
    const mirrored = (currentDeviceId === null && currentFacing === 'user');
    if (mirrored) {
      ctx.translate(vw, 0); ctx.scale(-1, 1);
    }
    ctx.drawImage(video, 0, 0, vw, vh);
    if (mirrored) { ctx.setTransform(1,0,0,1,0,0); }

    const imgURL = canvas.toDataURL('image/jpeg', 0.9);
    preview.src = imgURL;
    preview.style.display = 'block';
    video.style.display = 'none';

    // tus botones de retomar/subir (si los generas con innerHTML, vuelve a asignar listeners)
    if (btnsContainer) {
      btnsContainer.innerHTML = `
        <button id="retakeBtn" class="btn">Tomar otra</button>
        <button id="uploadBtn" class="btn">Subir</button>
      `;
      document.getElementById('retakeBtn').onclick = () => {
        preview.style.display = 'none';
        video.style.display = '';
      };
      document.getElementById('uploadBtn').onclick = () => {
        // aqu√≠ reusa tu l√≥gica de subida (FormData/endpoint)
        alert('Subir√≠a la foto aqu√≠ üöÄ (implementa tu fetch al servidor)');
      };
    }
  }

  // Eventos
  startBtn?.addEventListener('click', () => startCamera({ facingMode: 'user' }));
  toggleFacingBtn?.addEventListener('click', async () => {
    // Si usaste deviceId del selector, borra deviceId y alterna facing
    currentDeviceId = null;
    currentFacing = (currentFacing === 'user') ? 'environment' : 'user';
    await startCamera({ facingMode: currentFacing });
  });
  cameraSelector?.addEventListener('change', async (e) => {
    currentDeviceId = e.target.value;
    await startCamera({ deviceId: currentDeviceId });
  });

  // Reasigna el bot√≥n de ‚ÄúTomar Foto‚Äù existente a esta funci√≥n robusta
  if (shotBtn) {
    shotBtn.addEventListener('click', takePhoto);
  }

  // Limpieza al salir
  window.addEventListener('beforeunload', () => {
    if (stream) stream.getTracks().forEach(t => t.stop());
  });
})();
</script>

</body>
</html>
